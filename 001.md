# Azure DevOps Pipeline for Angular Application Deployment

trigger:
  branches:
    include:
    - main
    - develop
  paths:
    include:
    - src/*
    - package.json
    - angular.json

variables:
  # Build Variables
  buildConfiguration: 'production'
  nodeVersion: '18.x'
  angularVersion: '16'
  
  # Azure Variables
  azureSubscription: 'your-azure-subscription'
  resourceGroupName: 'rg-angular-app'
  storageAccountName: 'stangularapp$(Build.BuildId)'
  
  # Application Variables
  appName: 'my-angular-app'
  buildOutputPath: 'dist/$(appName)'

stages:
- stage: Build
  displayName: 'Build Angular Application'
  jobs:
  - job: BuildJob
    displayName: 'Build and Test'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    - task: NodeTool@0
      displayName: 'Install Node.js $(nodeVersion)'
      inputs:
        versionSpec: '$(nodeVersion)'
    
    - task: Cache@2
      displayName: 'Cache node_modules'
      inputs:
        key: 'npm | "$(Agent.OS)" | package-lock.json'
        restoreKeys: |
          npm | "$(Agent.OS)"
        path: '$(System.DefaultWorkingDirectory)/node_modules'
    
    - script: |
        npm ci
      displayName: 'Install dependencies'
    
    - script: |
        npm run lint
      displayName: 'Run ESLint'
      continueOnError: true
    
    - script: |
        npm run test -- --watch=false --browsers=ChromeHeadless --code-coverage
      displayName: 'Run unit tests'
    
    - task: PublishTestResults@2
      displayName: 'Publish test results'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'test-results.xml'
        searchFolder: '$(System.DefaultWorkingDirectory)'
      condition: succeededOrFailed()
    
    - task: PublishCodeCoverageResults@1
      displayName: 'Publish code coverage'
      inputs:
        codeCoverageTool: 'Cobertura'
        summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage/cobertura-coverage.xml'
        reportDirectory: '$(System.DefaultWorkingDirectory)/coverage'
      condition: succeededOrFailed()
    
    - script: |
        npm run build -- --configuration=$(buildConfiguration)
      displayName: 'Build Angular application'
    
    - task: ArchiveFiles@2
      displayName: 'Archive build artifacts'
      inputs:
        rootFolderOrFile: '$(buildOutputPath)'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(appName)-$(Build.BuildNumber).zip'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish build artifacts'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'angular-app'

- stage: DeployDev
  displayName: 'Deploy to Development'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
  variables:
    environment: 'dev'
    storageAccountName: 'stangularappdev'
  
  jobs:
  - deployment: DeployToDev
    displayName: 'Deploy to Development Environment'
    pool:
      vmImage: 'ubuntu-latest'
    environment: 'development'
    strategy:
      runOnce:
        deploy:
          steps:
          - template: templates/deploy-to-storage.yml
            parameters:
              environment: '$(environment)'
              storageAccountName: '$(storageAccountName)'
              resourceGroupName: '$(resourceGroupName)'

- stage: DeployProd
  displayName: 'Deploy to Production'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  variables:
    environment: 'prod'
    storageAccountName: 'stangularappprod'
  
  jobs:
  - deployment: DeployToProd
    displayName: 'Deploy to Production Environment'
    pool:
      vmImage: 'ubuntu-latest'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - template: templates/deploy-to-storage.yml
            parameters:
              environment: '$(environment)'
              storageAccountName: '$(storageAccountName)'
              resourceGroupName: '$(resourceGroupName)'

              # Template for deploying Angular app to Azure Storage Account

parameters:
- name: environment
  type: string
- name: storageAccountName
  type: string
- name: resourceGroupName
  type: string

steps:
- download: current
  artifact: 'angular-app'

- task: ExtractFiles@1
  displayName: 'Extract build artifacts'
  inputs:
    archiveFilePatterns: '$(Pipeline.Workspace)/angular-app/*.zip'
    destinationFolder: '$(Pipeline.Workspace)/extracted'

- task: AzureCLI@2
  displayName: 'Create Storage Account'
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      # Create resource group if it doesn't exist
      az group create --name ${{ parameters.resourceGroupName }} --location eastus2
      
      # Create storage account
      az storage account create \
        --name ${{ parameters.storageAccountName }} \
        --resource-group ${{ parameters.resourceGroupName }} \
        --location eastus2 \
        --sku Standard_LRS \
        --kind StorageV2
      
      # Enable static website hosting
      az storage blob service-properties update \
        --account-name ${{ parameters.storageAccountName }} \
        --static-website \
        --404-document index.html \
        --index-document index.html

- task: AzureCLI@2
  displayName: 'Deploy to Storage Account'
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      # Upload files to $web container
      az storage blob upload-batch \
        --account-name ${{ parameters.storageAccountName }} \
        --destination '$web' \
        --source '$(Pipeline.Workspace)/extracted' \
        --overwrite
      
      # Get the static website URL
      WEBSITE_URL=$(az storage account show \
        --name ${{ parameters.storageAccountName }} \
        --resource-group ${{ parameters.resourceGroupName }} \
        --query "primaryEndpoints.web" \
        --output tsv)
      
      echo "Application deployed to: $WEBSITE_URL"
      echo "##vso[task.setvariable variable=websiteUrl;isOutput=true]$WEBSITE_URL"

- task: AzureCLI@2
  displayName: 'Configure CDN (Optional)'
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      # Create CDN profile and endpoint for better performance
      az cdn profile create \
        --name "cdn-${{ parameters.storageAccountName }}" \
        --resource-group ${{ parameters.resourceGroupName }} \
        --sku Standard_Microsoft
      
      ORIGIN_URL=$(az storage account show \
        --name ${{ parameters.storageAccountName }} \
        --resource-group ${{ parameters.resourceGroupName }} \
        --query "primaryEndpoints.web" \
        --output tsv | sed 's|https://||' | sed 's|/||')
      
      az cdn endpoint create \
        --name "endpoint-${{ parameters.storageAccountName }}" \
        --profile-name "cdn-${{ parameters.storageAccountName }}" \
        --resource-group ${{ parameters.resourceGroupName }} \
        --origin $ORIGIN_URL \
        --origin-host-header $ORIGIN_URL
  condition: eq('${{ parameters.environment }}', 'prod')

  # Alternative: Deploy Angular App to Azure App Service

trigger:
  branches:
    include:
    - main
    - develop

variables:
  azureSubscription: 'your-azure-subscription'
  appName: 'angular-app-$(Build.BuildId)'
  resourceGroupName: 'rg-angular-app'
  appServicePlan: 'asp-angular-app'

stages:
- stage: Build
  displayName: 'Build Angular Application'
  jobs:
  - job: BuildJob
    displayName: 'Build'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'
    
    - script: |
        npm ci
        npm run build --prod
      displayName: 'Install and Build'
    
    - task: ArchiveFiles@2
      displayName: 'Archive files'
      inputs:
        rootFolderOrFile: 'dist/'
        includeRootFolder: false
        archiveType: zip
        archiveFile: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
        replaceExistingArchive: true
    
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
        artifactName: 'drop'

- stage: Deploy
  displayName: 'Deploy to Azure App Service'
  dependsOn: Build
  condition: succeeded()
  
  jobs:
  - deployment: DeployWeb
    displayName: 'Deploy Angular App'
    environment: 'production'
    pool:
      vmImage: 'ubuntu-latest'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureResourceManagerTemplateDeployment@3
            displayName: 'Create App Service'
            inputs:
              deploymentScope: 'Resource Group'
              azureResourceManagerConnection: '$(azureSubscription)'
              subscriptionId: '$(subscriptionId)'
              action: 'Create Or Update Resource Group'
              resourceGroupName: '$(resourceGroupName)'
              location: 'East US 2'
              templateLocation: 'Linked artifact'
              csmFile: 'arm-templates/app-service.json'
              overrideParameters: |
                -appName "$(appName)"
                -appServicePlanName "$(appServicePlan)"
          
          - task: AzureWebApp@1
            displayName: 'Deploy to Azure Web App'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: 'webApp'
              appName: '$(appName)'
              package: '$(Pipeline.Workspace)/drop/$(Build.BuildId).zip'

              {
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "appName": {
      "type": "string",
      "metadata": {
        "description": "The name of the web app"
      }
    },
    "appServicePlanName": {
      "type": "string",
      "metadata": {
        "description": "The name of the App Service plan"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    }
  },
  "variables": {},
  "resources": [
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2021-02-01",
      "name": "[parameters('appServicePlanName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "F1",
        "tier": "Free"
      },
      "properties": {}
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2021-02-01",
      "name": "[parameters('appName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
      ],
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
        "siteConfig": {
          "defaultDocuments": [
            "index.html"
          ],
          "httpErrors": {
            "404": {
              "responseMode": "Redirect",
              "responseURL": "/index.html"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "webAppUrl": {
      "type": "string",
      "value": "[concat('https://', reference(parameters('appName')).defaultHostName)]"
    }
  }
}


# Deploy Angular App as Container to Azure Container Instances

trigger:
  branches:
    include:
    - main

variables:
  dockerRegistryServiceConnection: 'your-acr-connection'
  imageRepository: 'angular-app'
  containerRegistry: 'youracr.azurecr.io'
  dockerfilePath: '**/Dockerfile'
  tag: '$(Build.BuildId)'
  
pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build and push stage
  jobs:
  - job: Build
    displayName: Build
    steps:
    - task: Docker@2
      displayName: Build and push image
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest

- stage: Deploy
  displayName: Deploy stage
  dependsOn: Build
  jobs:
  - deployment: Deploy
    displayName: Deploy to ACI
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureResourceManagerTemplateDeployment@3
            displayName: 'Deploy to Azure Container Instances'
            inputs:
              deploymentScope: 'Resource Group'
              azureResourceManagerConnection: '$(azureSubscription)'
              action: 'Create Or Update Resource Group'
              resourceGroupName: '$(resourceGroupName)'
              location: 'East US 2'
              templateLocation: 'Linked artifact'
              csmFile: 'arm-templates/container-instance.json'
              overrideParameters: |
                -containerName "$(imageRepository)"
                -imageUri "$(containerRegistry)/$(imageRepository):$(tag)"

                # Multi-stage Dockerfile for Angular Application

# Build stage
FROM node:18-alpine AS build

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm ci --only=production

# Copy source code
COPY . .

# Build the application
RUN npm run build --prod

# Production stage
FROM nginx:alpine

# Copy built application
COPY --from=build /app/dist/my-angular-app /usr/share/nginx/html

# Copy nginx configuration
COPY nginx.conf /etc/nginx/nginx.conf

# Expose port
EXPOSE 80

# Start nginx
CMD ["nginx", "-g", "daemon off;"]


events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    server {
        listen 80;
        server_name localhost;
        root /usr/share/nginx/html;
        index index.html;

        # Handle Angular routing
        location / {
            try_files $uri $uri/ /index.html;
        }

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        
        # Gzip compression
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
        
        # Cache static assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, no-transform";
        }
    }
}